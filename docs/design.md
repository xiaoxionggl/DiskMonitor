
---

````markdown
# DiskMonitor 系统设计文档

**版本**：v1.0.0  
**作者**：张界枰  
**最后更新**：2025-08-13  

---

## 1. 概述
DiskMonitor 是一个基于 **C++17** 标准库 `std::filesystem` 的高性能目录扫描工具，用于统计指定目录下子目录的磁盘占用情况。  
该工具采用**单进程单线程顺序扫描**的方式，保证实现简单且可维护性强，适合后续进行并发优化。

---

## 2. 系统架构

```plaintext
+-----------------+
|      main.cpp   |
|  参数解析 / CLI  |
+--------+--------+
         |
         v
+-----------------+         +-----------------------+
|  FileScanner    |<------->|  std::filesystem API  |
|  核心扫描逻辑    |         |  目录遍历 / 文件大小获取|
+--------+--------+         +-----------------------+
         |
         v
+-----------------+
|  结果集合 folders|
| (FolderInfo 列表)|
+--------+--------+
         |
         v
+-----------------+
|   输出模块       |
| (进度条 / 报告)  |
+-----------------+
````

---

## 3. 数据流

```mermaid
flowchart TD
    A[用户输入路径] --> B[CLI 层解析路径]
    B --> C[调用 FileScanner.scan()]
    C --> D[收集第一层子目录列表]
    D --> E[递归计算文件总字节数]
    E --> F[转换为 GB]
    F --> G[按阈值过滤 / 排序]
    G --> H[返回 FolderInfo 列表]
    H --> I[CLI 层格式化输出]
```

---

## 4. 核心算法

### 4.1 目录体积计算

```cpp
for (auto& p : fs::recursive_directory_iterator(
        folderPath, 
        fs::directory_options::skip_permission_denied)) 
{
    if (p.is_regular_file()) {
        totalBytes += p.file_size();
    }
}
```

* 遍历策略：**递归遍历子目录**
* 跳过无法访问的目录（权限不足时不中断流程）
* 复杂度：

  * **时间复杂度** O(N)

    * N = 文件总数（I/O 操作为主）
  * **空间复杂度** O(M)

    * M = 符合条件的子目录数量

---

## 5. 性能分析

| 因素     | 当前情况                 | 改进空间              |
| ------ | -------------------- | ----------------- |
| I/O 并发 | 单线程顺序                | 可改为多线程异步扫描        |
| 文件系统调用 | 直接调用 `fs::file_size` | 可批量读取元数据以减少系统调用次数 |
| 内存占用   | 仅存储 FolderInfo       | 低风险，无需优化          |
| 排序性能   | O(M log M)           | 对 M 较大时可用并行排序     |

---

## 6. 异常处理策略

* 路径不存在 → 抛出 `std::runtime_error`
* 目标非目录 → 抛出 `std::runtime_error`
* 权限不足 → 跳过该路径（使用 `directory_options::skip_permission_denied`）
* 文件被占用 → 跳过，不中断扫描

---

## 7. 扩展计划

| 功能                | 优先级 | 说明                 |
| ----------------- | --- | ------------------ |
| 配置文件（JSON）支持      | 高   | 用户可修改扫描路径、阈值、排序方式  |
| 多线程扫描             | 高   | 提升大目录扫描速度          |
| GUI 界面            | 中   | Qt 或 ImGui         |
| 单元测试              | 中   | 使用 `gtest` 验证计算正确性 |
| GitHub Actions CI | 中   | 每次提交自动编译与测试        |

---

## 8. 版本控制与提交规范

* 分支模型：`main`（稳定版）、`dev`（开发版）
* 提交信息格式：

```
feat: 新功能
fix: 修复 bug
refactor: 重构代码
docs: 更新文档
```

* Tag 命名：`v<主版本>.<次版本>.<修订版>`（例如：v1.0.0）

---

## 9. 依赖与环境

* **C++17**
* **CMake ≥ 3.10**
* Windows / Linux / macOS（需支持 `std::filesystem`）

---

## 10. 维护者

* **张界枰**（主要开发者）
* 邮箱：`15901174399@139.com`

```


